<?php
// $Id$

/**
 * Implementation of hook_autoload_info().
 */
function conglomerate_autoload_info() {
  return array(
    'ConglomerateContentResource' => array(
      'file' => 'ConglomerateContentResource.php',
    ),
    'ConglomerateContentFeedModel' => array(
      'file' => 'ConglomerateContentFeedModel.php',
    ),
  );
}

/**
 * Implementation of hook_services_resources().
 */
function conglomerate_services_resources() {
  $res = array(
    // Conglomerate resource
    'conglomerate-content' => ServicesOop::definitionFromClass('ConglomerateContentResource'),
  );
  return $res;
}

/**
 * Implementation of hook_oauth_default_contexts().
 */
function conglomerate_oauth_default_contexts() {
  return array(
    'conglomerate' => array(
      '*' => array(
        'title' => 'Yes, I want to connect !appname to !sitename',
        'description' => 'This will allow your site !appname to push content to !sitename',
        'weight' => -1,
      ),
      'read' => array(
        'title' => 'I want to connect, but just to get stuff from !sitename',
        'description' => 'This will allow !appname to fetch content from !sitename, but it will not allow any information to be pushed to !sitename.',
        'weight' => 0,
      ),
    )
  );
}

/**
 * Implementation of hook_services_contexts().
 */
function conglomerate_services_contexts() {
  return array(
    'conglomerate' => array(
      'title' => 'Conglomerate API',
      'server' => 'rest_server',
      'path' => 'api',
      'authentication' => 'services_oauth',
      'authentication_settings' => array(
        'oauth_context' => 'conglomerate',
      ),
      'resources' => array(
        'conglomerate-content' => array(
          'alias' => 'content',
          'operations' => array(
            'create' => array(
              'enabled' => TRUE,
              'oauth_credentials' => 'token',
              'oauth_authorization' => '*',
            ),
            'retrieve' => array(
              'enabled' => TRUE,
              'oauth_credentials' => 'unsigned_consumer',
              'oauth_authorization' => 'read',
            ),
            'update' => array(
              'enabled' => TRUE,
              'oauth_credentials' => 'token',
              'oauth_authorization' => '*',
            ),
            'delete' => array(
              'enabled' => TRUE,
              'oauth_credentials' => 'token',
              'oauth_authorization' => '*',
            ),
            'index' => array(
              'enabled' => TRUE,
              'oauth_credentials' => 'unsigned_consumer',
              'oauth_authorization' => 'read',
            ),
          ),
        ),
        'solr' => array(
          'alias' => 'search',
          'operations' => array(
            'index' => array(
              'enabled' => TRUE,
              'preprocess' => '_conglomerate_modify_solr_search',
              'oauth_credentials' => 'unsigned_consumer',
              'oauth_authorization' => 'read',
            ),
          )
        ),
      ),
    ),
  );
}

/**
 * Implementation of hook_nodeapi().
 */
function conglomerate_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  $update = NULL;
  switch ($op) {
    case 'update':
      $update = array('nid');
    case 'insert':
      if (isset($node->conglomerate_source)) {
        $record = array(
          'nid' => $node->nid,
          'sid' => $node->conglomerate_source,
          'duplicate_of' => $noce->conglomerate_duplicate_of,
        );
        drupal_write_record('conglomerate_node_source', $record, $update);
      }
    break;
    case 'load':
      $info = db_fetch_object(db_query("SELECT sid, duplicate_of FROM {conglomerate_node_source}
        WHERE nid = %d",
          array(
            ':nid' => $node->nid,
      )));
      return array(
        'conglomerate_source' => $info->sid,
        'conglomerate_duplicate_of' => $info->duplicate_of,
      );
    break;
  }
}

/**
 * Loads source information when given a oauth consumer object or key.
 *
 * @param mixed $consumer
 *  A DrupalOAuthConsumer consumer key
 * @return void
 */
function conglomerate_source_from_consumer($consumer) {
  if (is_object($consumer)) {
    $consumer = $consumer->key;
  }
  return db_fetch_object(db_query("SELECT * FROM {conglomerate_source}
    WHERE oauth_consumer = '%s'"));
}

/**
 * Implementation of hook_apachesolr_update_index().
 */
function conglomerate_apachesolr_update_index(&$doc, $node) {
  if (isset($node->conglomerate_source)) {
    $doc->addField('is_conglomerate_source', $node->conglomerate_source);
    $doc->addField('is_conglomerate_duplicate_of', $node->conglomerate_duplicate_of);
  }
}

function _conglomerate_modify_solr_search(&$parameters) {
  // Do stuff to enforce sensible restrictions
}

/**
 * Test blocks
 */
function conglomerate_block($op = 'list', $delta = 0, $edit = array()) {
  switch ($op) {
    case 'list':
      $blocks = array(
        'featured' => array(
          'info'    => 'TEST Featured',
          'region'  => 'belowcontent',
          'weight'  => 0,
        ),
        'tags' => array(
          'info'    => 'TEST Tags',
          'region'  => 'belowcontent',
          'weight'  => 10,
        ),
        'flickr' => array(
          'info'    => 'TEST Flickr',
          'region'  => 'widecontent',
          'weight'  => 0,
        ),
        
        // Lists
        'hotels' => array(
          'info'    => 'TEST Popular Hotels',
          'region'  => 'lists',
          'weight'  => 0,
        ),
        'see' => array(
          'info'    => 'TEST Seeworthy',
          'region'  => 'lists',
          'weight'  => 10,
        ),
        'restaurants' => array(
          'info'    => 'TEST Restaurant',
          'region'  => 'lists',
          'weight'  => 20,
        ),
        'blog' => array(
          'info'    => 'TEST Latest blog',
          'region'  => 'lists',
          'weight'  => 30,
        ),
        
        // Footer stuff
        'logo' => array(
          'info'    => 'TEST Footer Logo',
          'region'  => 'footer_one',
          'weight'  => 0,
        ),
        'orgnr' => array(
          'info'    => 'TEST Footer Org',
          'region'  => 'footer_two',
          'weight'  => 0,
        ),
        'contact' => array(
          'info'    => 'TEST Footer Contact',
          'region'  => 'footer_three',
          'weight'  => 0,
        ),
        'meta' => array(
          'info'    => 'TEST Footer Meta',
          'region'  => 'footer_four',
          'weight'  => 0,
        ),
        
        // Header stuff
        'language' => array(
          'info'    => 'TEST Language select',
          'region'  => 'header_left',
          'weight'  => 0,
        ),
        'invest' => array(
          'info'    => 'TEST Skåne links',
          'region'  => 'header_rights',
          'weight'  => 0,
        ),
      );
      
      return $blocks;
      
    // Render blocks
    case 'view':
      // Wich block?
      switch ($delta) {
        case 'featured':
          return array('content' => '<img src="' . url(drupal_get_path('theme', 'skane')) . '/gfx/remove_this.jpg" alt="" class="test_image" />');
          
        case 'tags':
          return array('content' => 'Random ord text Skane.com Skåne Finland Häst Båt Mos Gurka Glas Fotboll Ystad Vstad Safari Solrosfrön Balja');
      
        case 'hotels':
          return array('title' => 'Populära hotel', 'content' => '<ol>   <li><a href="#">Grand Hotel</a></li>   <li><a href="#">Örenäs Slott Hotell &amp; konferens</a></li>   <li><a href="#">Hotel Lundia</a></li>   <li><a href="#">First Hotel Jörgen Kock</a></li>   <li><a href="#">Radison SAS Hotel</a></li>   <li><a href="#">Hotel Kärnan</a></li>   <li><a href="#">First Hotel Planetstaden</a></li>   <li><a href="#">Kiviks Hotell</a></li>   <li><a href="#">Hilton Malmö City</a></li>   <li><a href="#">Hotel Plaza</a></li> </ol>');
          
        case 'see':
          return array('title' => 'Populära sevärdheter', 'content' => '<ol>   <li><a href="#">Skånes Djurpark</a></li>   <li><a href="#">Ystad Djurpark</a></li>   <li><a href="#">Tropikariet Helsingborg</a></li>   <li><a href="#">Tosselilla Sommarland</a></li>   <li><a href="#">Botaniska Trädgården</a></li>   <li><a href="#">Skanörs Fiskrögeri</a></li>   <li><a href="#">Kulturbolaget - KB</a></li>   <li><a href="#">Ales Stenar</a></li>   <li><a href="#">Glimmingehus</a></li>   <li><a href="#">Terrariet Reptilcenter</a></li> </ol>');
          
        case 'restaurants':
          return array('title' => 'Populära restauranger', 'content' => '<ol>   <li><a href="#">Lagmark Gastronomi</a></li>   <li><a href="#">Cade le fil du Rasoir</a></li>   <li><a href="#">Smaka</a></li>   <li><a href="#">Bloom In the Park</a></li>   <li><a href="#">Torso Twisted</a></li>   <li><a href="#">Vendel du Sturehof</a></li>   <li><a href="#">Årstiderna</a></li>   <li><a href="#">Mento</a></li>   <li><a href="#">Mrs Brown</a></li>   <li><a href="#">La Roche</a></li> </ol>');
          
        case 'blog':
          return array('title' => 'Nyligen bloggat', 'content' => '<ul>   <li>     <h4><span class="time">11:15</span> Hammenhögs Gästgivaregård</h4>     <p>       Hammenhög     </p>   </li>   <li>     <h4><span class="time">09:07</span> Grå Helgonört</h4>     <p>       Fråga om ettikett     </p>   </li>   <li>     <h4><span class="time">09:00</span> American är nya temat</h4>     <p>       The Lodge     </p>   </li>   <li>     <h4><span class="time">07:05</span> Gratis föreläsning på Zam Zam</h4>     <p>       Zam Zam     </p>   </li>   <li>     <h4><span class="time">06:00</span> Guldkant i tillvaron</h4>     <p>       Torekov hotell     </p>   </li> </ul>');
      
        case 'logo':
          return array('title' => '', 'content' => 'TOURISM IN SKÅNE LOGO ETC');
          
        case 'orgnr':
          return array('title' => 'Tourism in Skåne AB', 'content' => 'Org.nr: 556750-6398');
          
        case 'contact':
          return array('title' => 'Kontakta oss', 'content' => 'Tourism in Skåne AB<br /> Stortorget 9, SE-211 22 Malmö<br /> Tel. +46 (0)40-623 98 00<br /> tourism@skane.com');
        
        case 'meta':
          return array('title' => '', 'content' => '<h3>   <img src="/sites/default/themes/skane/gfx/rss.jpg" alt="RSS" />Prenumerera &mdash; RSS </h3> <ul>   <li><a href="#">Användarvillkor</a></li>   <li><a href="#">PUL Personuppgiftslagen</a></li>   <li><a href="#">Vi använder cookies</a></li> </ul>');
        
        case 'language':
          return array('title' => 'Språk', 'content' => '<ul><li class="active"><a href="#">På svenska</a></li><li><a href="#">In English</a></li><li><a href="#">Je suis un cheval</a></li></ul>');
      
        case 'invest':
          return array('title' => '', 'content' => '<ul><li><a href="#"><strong>event</strong> in skåne</a></li><li><a href="#"><strong>invest</strong> in skåne</a></li></ul>');
      }
      break;
  }
}